<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Demo YDKJ</title>
<style>
@font-face {
font-family:"JackCondensed";
src: url("fonts/JAC_____.TTF") format('truetype') /* TTF file for CSS3 browsers */
}

@font-face {
font-family:"JackExtraCond";
src: url("fonts/JAeC____.TTF") format('truetype') /* TTF file for CSS3 browsers */
}

@font-face {
font-family:"JackInput";
src: url("fonts/JAi_____.TTF") format('truetype') /* TTF file for CSS3 browsers */
}

@font-face {
font-family:"JackRoman";
src: url("fonts/JAr_____.TTF") format('truetype') /* TTF file for CSS3 browsers */
}

span, div {
  cursor:default;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

</style>
<script src="demo-res.js" type="text/javascript"></script>
<script src="jquery-1.11.0.min.js" type="text/javascript"></script>
<script src="SeamlessLoop.js" type="text/javascript"></script>
<script type="text/javascript">

/********** Quelques fonctions pour le son **********/

function AudioSpecs() {
  	this.is = {
			  ff: Boolean(!(window.mozInnerScreenX == null) && /firefox/.test( navigator.userAgent.toLowerCase() )),
			  ie: Boolean(document.all && !window.opera),
			  opera: Boolean(window.opera),
			  chrome: Boolean(window.chrome),
			  safari: Boolean(!window.chrome && /safari/.test( navigator.userAgent.toLowerCase() ) && window.getComputedStyle && !window.globalStorage && !window.opera)
			};
	this.playDelay = -30; // IE 1500
	this.stopDelay = 30;  // IE 20
	this.maxVolume = 1;
	if(this.is.chrome) this.playDelay = -25;
	if(this.is.chrome) this.stopDelay = 25;
	if(this.is.chrome) this.maxVolume = 0.8;
	if(this.is.ff) this.playDelay = -25;
	if(this.is.ff) this.stopDelay = 85;
	if(this.is.opera) this.playDelay = 5;
	if(this.is.opera) this.stopDelay = 0;
}

var audiospecs = new AudioSpecs();

/********** Quelques fonctions pour le preload **********/

// 'fireOne' argument is optional, if set, will invoke the callback once for every
// image in the 'this' collection, thus making 'this' in the callback that element alone
// If it's not used, the callback will be invoked once all the images in the collection has
// been loaded. And 'this' will be the jQuery collection of the filtered 'img' elements.

jQuery.fn.imagesLoaded = function(callback, fireOne) {
  var
    args = arguments,
    elems = this.filter('img'),
    elemsLen = elems.length - 1;

  elems
    .bind('load', function(e) {
        if (fireOne) {
            !elemsLen-- && callback.call(elems, e);
        } else {
            callback.call(this, e);
        }
    }).each(function() {
        // cached images don't fire load sometimes, so we reset src.
        if (this.complete || this.complete === undefined) {
            if (jQuery(this).hasClass('alreadyLoaded')) jQuery(this).trigger('load'); else this.src = this.src;
        }
    });
}

function waitForAudio(selector,callback) {
  var waitloop = function() {
    var elems = jQuery(selector);
    var totalAudio = elems.length;
    elems.each(function(){if (this.duration) totalAudio--;});
    if (totalAudio) window.setTimeout(function(){waitloop()},50); else callback.call();
  }
  waitloop();
}

/********** YDKJFile **********/

var preloadpool = new Array();
var preloadfifo = new Array();
var preloadprocesses = 0;
var fileID = 0;
function YDKJFile(filetype,url) {
  this.id = fileID++;
  this.filetype = filetype;
  this.url = url;
  this.res = 0;
  
  this.preloaded = 0;
  this.readyFunctions = [];
  
  if (preloadprocesses < 2) {
    preloadprocesses++;
    this.preload();
  } else preloadfifo.push(this);
}

YDKJFile.prototype.preload = function(f) {
  var thisFile = this;
  var preload = jQuery('#preload');
  
  var isready = function() {
    thisFile.preloaded = 1;
    
    var nextfile = preloadfifo.shift();
    if (nextfile) nextfile.preload(); else preloadprocesses--;
    
    for(var i = 0; i < thisFile.readyFunctions.length; i++) {
      thisFile.readyFunctions[i].call(thisFile);
    }
  }
  
  if (this.filetype == 'gif') {
    this.res = preload.append('<img />').children().last().attr('id','file'+this.id).attr('src',this.url)
    this.res.imagesLoaded(isready);
  }
  
  if (this.filetype == 'js') {
    jQuery.ajax({
      url: this.url,
      type: 'get',
      dataType: 'text',
      success: function(html, status, xhr) {
        var res = new Array();
        eval(html);
        thisFile.res = res;
        isready();
      },
      error: function (xhr, ajaxOptions, thrownError){
        //displayLoader(false);
      }
    });
  }
  
  if (this.filetype == 'audio') {
    this.res = preload.append('<audio />').children().last().attr('id','file'+this.id);
    var a = this.res.get(0);
    if (a.canPlayType('audio/ogg')) this.res.append('<source />').children().last().attr('type','audio/ogg').attr('src',this.url+'.ogg');
    else if (a.canPlayType('audio/mpeg')) this.res.append('<source />').children().last().attr('type','audio/mpeg').attr('src',this.url+'.mp3');
    else {
      this.res.append('<source />').children().last().attr('type','audio/ogg').attr('src',this.url+'.ogg');
      this.res.append('<source />').children().last().attr('type','audio/mpeg').attr('src',this.url+'.mp3');
    }
    waitForAudio(this.res,isready);
  }
}

YDKJFile.prototype.ready = function(f) {
  if (!this.preloaded) this.readyFunctions.push(f); else f.call(this);
}

YDKJFile.prototype.free = function() {
  preloadpool[this.url].used--;
  if (preloadpool[this.url].used <= 0) {
    jQuery('#preload').find('#file'+this.id).remove();
    this.res = undefined;
    preloadpool[this.url] = 0;
  }
}

function getYDKJFile(filetype,url) {
  if (preloadpool[url]) {
    preloadpool[url].used++;
    return preloadpool[url].file;
  }
  var f = new YDKJFile(filetype,url);
  preloadpool[url] = {file:f,used:1};
  return f;
}


/********** YDKJAnimation **********/

var animID=0;
function YDKJAnimation(urlGif,urlJS,urlAudio,framestart,loop,framestop) {
  this.id = animID++;
  this.urlGif = urlGif;
  this.urlJS = urlJS;
  this.urlAudio = urlAudio;
  if (typeof(framestart) === 'undefined') framestart = 0;
  if (typeof(loop) === 'undefined') loop = 0;
  if (typeof(framestop) === 'undefined') framestop = 0;
  this.framestart = framestart;
  this.loop = loop;
  this.framestop = framestop;
  this.seamlessLoop = 0;
  
  this.isplaying = 0;
  this.end = 0;
  this.endedFunctions = [];

  this.tiles = 0;
  this.frames = 0;
  this.intervalTimer = 0;
  this.audiostopTimer = 0;

  this.preloaded = 0;
  this.readyFunctions = [];

  // Lancement du preload

  this.gif = 0;
  if (this.urlGif != '') this.gif = getYDKJFile('gif',this.urlGif);
  this.js = 0;
  if (this.urlJS != '') this.js = getYDKJFile('js',this.urlJS);
  this.audio = 0;
  if (this.urlAudio != '') this.audio = getYDKJFile('audio',this.urlAudio);

  // Vérifier le statut du preload, dans l'ordre inverse, soit : gif -> js -> audio -> seamlessloop

  var thisAnim = this;
  
  var seamlessloopready = function() {
    thisAnim.preloaded = 1;
    for(var i = 0; i < thisAnim.readyFunctions.length; i++) {
      thisAnim.readyFunctions[i].call(thisAnim);
    }
  }
  
  var audioready = function() {
    if ((thisAnim.audio) && (thisAnim.loop)) {
      var audiofile = thisAnim.audio.res;
      if (audiofile) {
        var audioelem = audiofile.get(0);
        thisAnim.seamlessLoop = new SeamlessLoop();
        thisAnim.seamlessLoop.addUri(thisAnim.urlAudio,audioelem.duration*1000,'loop'+thisAnim.id);
        seamlessloopready();
      }
    } else seamlessloopready();
  }
  
  var jsready = function() {
    if (thisAnim.js) {
      thisAnim.tiles = thisAnim.js.res['tiles'];
      thisAnim.frames = thisAnim.js.res['frames'];
    }
    if (thisAnim.audio) thisAnim.audio.ready(audioready); else audioready();
  }
  
  var gifready = function() {
    if (thisAnim.js) thisAnim.js.ready(jsready); else jsready();
  }
  
  if (this.gif) this.gif.ready(gifready); else gifready();
  
  // Méthodes privées
    
  this.newScreen = function() {
    var thisdiv = $('#tmpscreen').find('#anim'+this.id);
    if (thisdiv.length == 0) {
      thisdiv = jQuery('<div />').attr('id','anim'+this.id);
      thisdiv.appendTo($('#tmpscreen'));
    }
    thisdiv.html('');
  }
  
  this.addTile = function(tileid, x, y) {
    var tmpscreen = $('#tmpscreen').find('#anim'+this.id);
    var ourtile = this.tiles[tileid];
    if (!ourtile) return false;
    var ourdiv = $('<div />');
    ourdiv.css({
      'background-image':'url("'+this.urlGif+'")',
      'background-repeat':'none',
      'background-position':(0-ourtile.x)+'px '+(0-ourtile.y)+'px',
      'width':(ourtile.w)+'px',
      'height':(ourtile.h)+'px',
      'position':'absolute',
      'left':x+'px',
      'top':y+'px',
    });
    ourdiv.appendTo(tmpscreen);
  }
  
  this.addFrame = function(frameid) {
    var ourframe = this.frames[frameid];
    var val = 0;
    if (ourframe.nbimg > 0) {
      var offsetx = ourframe.img[0].ox;
      var offsety = ourframe.img[0].oy;
      var sizex = ourframe.img[0].sx;
      var sizey = ourframe.img[0].sy;
      val = ourframe.img[0].val;
      for(var i = 1; i <= ourframe.nbimg; i++) {
        this.addTile(ourframe.img[i].idx-1, offsetx+ourframe.img[i].ox, offsety+ourframe.img[i].oy);
        val = val | ourframe.img[i].val;
      }
      return val;
    }
    return val;
  }
  
  this.getFrameVal = function(frameid) {
    var ourframe = this.frames[frameid];
    var val = 0;
    if (ourframe.nbimg > 0) {
      val = ourframe.img[0].val;
      for(var i = 1; i <= ourframe.nbimg; i++) {
        val = val | ourframe.img[i].val;
      }
      return val;
    }
    return val;
  }
  
  this.nextScreen = function() {
    // Ne pas remplacer tout le screen (uniquement supprimer lorsqu'on destroy l'animation (pas stop, on peut vouloir stopper sans supprimer))
    var thisdiv = $('#screen').find('#anim'+this.id);
    var tmpscreen = $('#tmpscreen').find('#anim'+this.id);
    if (thisdiv.length == 0) {
      thisdiv = jQuery('<div />').attr('id','anim'+this.id).css({
        'position':'absolute',
      });
      thisdiv.appendTo($('#screen'));
    }
    $('#screen').find('.markedAsRemoved').remove(); // Supprimer les éléments marqués
    thisdiv.html(tmpscreen.html()); // Meilleure façon de déplacer les éléments ?
    
    /*
    // Chrome n'aime pas cette façon non plus (en fait il aime pas en local uniquement... il gère le cache des images différemment il faut croire ?)
    var newscreen = $('#tmpscreen').clone(true);
    newscreen.attr('id','screen').attr('style',$('#screen').attr('style'));
    $('#screen').replaceWith(newscreen);
    */
  
    this.newScreen();
  }
  
  this.endTrigger = function(e) {
    if (this.end == 255) return false;
    // e = 1 : animation, e = 2 : audio
    this.end = this.end | e;
    if (((this.urlGif == '') && (this.urlAudio != '') && (this.end == 2)) 
     || ((this.urlGif != '') && (this.urlAudio == '') && (this.end == 1)) 
     || ((this.urlGif != '') && (this.urlAudio != '') && (this.end == 3))) {
      this.isplaying = 0;
      this.end = 255; // Pour éviter de relancer le trigger
      for(var i = 0; i < this.endedFunctions.length; i++) {
        this.endedFunctions[i].call(this);
      }
    }
  }
}

YDKJAnimation.prototype.ready = function(f) {
  if (!this.preloaded) this.readyFunctions.push(f); else f.call(this);
};

YDKJAnimation.prototype.ended = function(f) {
  if (this.end != 255) this.endedFunctions.push(f); else f.call(this);
}

YDKJAnimation.prototype.playAnim = function() {
  if (!this.preloaded) return false; // Ou bien attendre le preload ?
  
  this.isplaying = 1;
  this.end = 0;
  var thisAnim = this;
  
  if (this.urlGif != '') {
    this.newScreen();

    var framenum = this.framestart;
    var framestop = this.frames.length-1;
    if (this.framestop) framestop = this.framestop;
    this.intervalTimer = 0;
    var intervaltimer = 0;
    var runanim = function() {
      //setTimeout(runanim,66);
      var val = thisAnim.addFrame(framenum);
      if (((val & 4) == 0) || ((val & 8) != 0)) thisAnim.nextScreen();
      if (((val & 32) != 0) && ((val & 8) != 0) && (thisAnim.animCallback)) thisAnim.animCallback();
      jQuery('#debuglive').html('frame '+framenum+'/'+(thisAnim.frames.length-1)+' ; val:'+val);
      framenum++;
      if ((framenum > framestop) || ((val & 16) != 0)) {
        if (thisAnim.loop) framenum = thisAnim.framestart; else {
          thisAnim.endTrigger(1);
          clearInterval(intervaltimer);
          thisAnim.intervalTimer = 0;
        }
      }
    }
  
    //runanim();
    intervaltimer = setInterval(runanim,66); // Pourrait être calculé depuis frames[x].fps1/frames[x].fps2
    this.intervalTimer = intervaltimer;
  }

  if (this.audio) {
    if ((this.loop) && (this.seamlessLoop)) {
      this.seamlessLoop.volume=audiospecs.maxVolume;
      this.seamlessLoop.start('loop'+this.id);
    } else {
      var audiofile = this.audio.res;
      if (audiofile) {
        var audioelem = audiofile.get(0);
        var ended = function() {
          thisAnim.audiostopTimer = 0;
          if (!thisAnim.loop) {
            setTimeout(function() {
              audioelem.pause();
              audioelem.currentTime = 0;
            }, audiospecs.stopDelay);
            thisAnim.endTrigger(2);
          }
        }
        thisAnim.audiostopTimer = setTimeout(ended, audioelem.duration*1000+audiospecs.playDelay);
        if (audioelem.currentTime) audioelem.currentTime = 0;
        audioelem.volume=audiospecs.maxVolume;
        audioelem.play();
      }
    }
  }
}

YDKJAnimation.prototype.stopAnim = function() {
  this.isplaying = 0;
  
  if (this.urlGif != '') {
    if (this.intervalTimer) {
      clearInterval(this.intervalTimer);
      this.intervalTimer = 0;
    }
  }
  
  if (this.audio) {
    if ((this.loop) && (this.seamlessLoop)) {
      this.seamlessLoop.stop();
    } else {
      if (this.audiostopTimer) clearTimeout(this.audiostopTimer);
      this.audiostopTimer = 0;
      var audiofile = this.audio.res;
      if (audiofile) {
        var audioelem = audiofile.get(0);
        audioelem.pause();
        audioelem.currentTime = 0;
      }
    }
  }
}

YDKJAnimation.prototype.resetAnim = function() {
  this.stopAnim();
  if (this.urlGif != '') {
    this.newScreen();
    this.nextScreen();
  }
}

YDKJAnimation.prototype.free = function() {
  this.stopAnim();
  if (this.gif) this.gif.free();
  if (this.js) this.js.free();
  if (this.audio) this.audio.free();
  jQuery('#screen').find('#anim'+this.id).addClass('markedAsRemoved'); // Sera retiré réellement à la prochaine animation (pour éviter les écrans noirs entre animations)
  jQuery('#tmpscreen').find('#anim'+this.id).remove();
}

YDKJAnimation.prototype.setVolume = function(vol) {
  if (vol > 1) vol = vol/100;
  vol = vol*audiospecs.maxVolume;
  
  if (this.audio) {
    if ((this.loop) && (this.seamlessLoop)) {
      this.seamlessLoop.setVolume(vol);
    } else {
      var audiofile = this.audio.res;
      if (audiofile) {
        var audioelem = audiofile.get(0);
        audioelem.volume = vol;
      }
    }
  }
}

YDKJAnimation.prototype.setAnimCallback = function(callback) {
  this.animCallback = callback;
}

/********** YDKJResource **********/

function YDKJResource(resourceName) {
  this.resourceName = resourceName;
  
  this.preloaded = 0;
  this.readyFunctions = [];
  
  this.isplaying = 0;
  this.end = 0;
  this.endedFunctions = [];
  
  var sp = resourceName.split('/');
  var resGif = '';
  var resJS = '';
  var resAudio = '';
  var resFramestart = 0;
  var resFramestop = 0;
  var resLoop = 0;
  if ((YDKJanim[sp[0]]) && (YDKJanim[sp[0]][sp[1]])) {
    var resGif = 'res/'+YDKJanim[sp[0]][sp[1]]['res']+'/'+YDKJanim[sp[0]][sp[1]]['name']+'.gif';
    var resJS = 'res/'+YDKJanim[sp[0]][sp[1]]['res']+'/'+YDKJanim[sp[0]][sp[1]]['name']+'.js';
    var resFramestart = YDKJanim[sp[0]][sp[1]]['framestart'];
    if (YDKJanim[sp[0]][sp[1]]['loop']) var resLoop = 1;
    if (YDKJanim[sp[0]][sp[1]]['framestop']) var resFramestop = YDKJanim[sp[0]][sp[1]]['framestop'];
  }
  
  if ((YDKJsnd[sp[0]]) && (YDKJsnd[sp[0]][sp[1]])) {
    var resAudio = 'res/'+YDKJsnd[sp[0]][sp[1]]['res']+'/'+YDKJsnd[sp[0]][sp[1]]['name']+'/'+YDKJsnd[sp[0]][sp[1]]['min'];
    if (YDKJsnd[sp[0]][sp[1]]['loop']) var resLoop = 1;
  } else if ((YDKJsnd[sp[0]]) && (YDKJsnd[sp[0]]['SFX'+sp[1]])) {
    var resAudio = 'res/'+YDKJsnd[sp[0]]['SFX'+sp[1]]['res']+'/'+YDKJsnd[sp[0]]['SFX'+sp[1]]['name']+'/'+YDKJsnd[sp[0]]['SFX'+sp[1]]['min'];
    if (YDKJsnd[sp[0]]['SFX'+sp[1]]['loop']) var resLoop = 1;
  }
  
  this.animation = new YDKJAnimation(resGif,resJS,resAudio,resFramestart,resLoop,resFramestop);

  var thisResource = this;

  this.animation.ended(function() {
    thisResource.isplaying = 0;
    thisResource.end = 1;
    for(var i = 0; i < thisResource.endedFunctions.length; i++) {
      thisResource.endedFunctions[i].call(thisResource);
    }
  });
  
  this.animation.ready(function(){
    thisResource.preloaded = 1;
    for(var i = 0; i < thisResource.readyFunctions.length; i++) {
      thisResource.readyFunctions[i].call(thisResource);
    }
  });
}

YDKJResource.prototype.ready = function(f) {
  if (!this.preloaded) this.readyFunctions.push(f); else f.call(this);
};

YDKJResource.prototype.ended = function(f) {
  if (!this.end) this.endedFunctions.push(f); else f.call(this);
};

YDKJResource.prototype.delay = function(f,delay) {
  var thisResource = this;
  if (delay) setTimeout(function(){f.call(thisResource)},delay); else f.call(this);
}

YDKJResource.prototype.playResource = function() {
  var thisResource = this;
  this.end = 0;
  this.animation.ready(function(){
    thisResource.isplaying = 1;
    thisResource.animation.playAnim();
  });
}

YDKJResource.prototype.stopResource = function() {
  this.isplaying = 0;
  this.animation.stopAnim();
}

YDKJResource.prototype.resetResource = function() {
  this.isplaying = 0;
  this.animation.resetAnim();
}

YDKJResource.prototype.setAnimCallback = function(callback) {
  this.animation.setAnimCallback(callback);
}

YDKJResource.prototype.free = function() {
  this.isplaying = 0;
  this.animation.free();
}

/********** Saisie au clavier **********/

function bindKeyListener(callback,timeout){
  if (typeof(timeout) === 'undefined') timeout = 0;
  var listener = function(event){callback(event.which)};
  jQuery(window).bind('keypress',listener);
  return listener;
}

function unbindKeyListener(listener) {
  jQuery(window).unbind('keypress',listener);
}

/********** Animation de transformation **********/

function animTransform(elem,fromx,tox,fromy,toy,speed,w,h,callback) {
	var expandInterval = 0;
	var expandValX = fromx;
	var expandValY = fromy;
	var expand = function() {
		expandValX += (tox-fromx)*speed;
		expandValY += (toy-fromy)*speed;
		
		if (tox > fromx) {if (expandValX >= tox) expandValX = tox;} else {if (expandValX <= tox) expandValX = tox;}
		if (toy > fromy) {if (expandValY >= toy) expandValY = toy;} else {if (expandValY <= toy) expandValY = toy;}
		
		if ((expandValX == tox) && (expandValY == toy)) {
			clearInterval(expandInterval);
			if (callback) callback();
		}
	  
		elem.css({
			'left':(0-((w/2)*(1-expandValX)))+'px',
			'top':(0-((h/2)*(1-expandValY)))+'px',
			'-webkit-transform':'scale('+expandValX+', '+expandValY+')',
  		'-moz-transform':'scale('+expandValX+', '+expandValY+')',
  		'-ms-transform':'scale('+expandValX+', '+expandValY+')',
  		'-o-transform':'scale('+expandValX+', '+expandValY+')',
  		'transform':'scale('+expandValX+', '+expandValY+')',
		});
	}
	expandInterval = setInterval(expand,66);
}

function getSTRfromID(STR,id) {
  for(var i = 0; i < STR.length; i++) if (STR[i].id == id) return STR[i].str;
  return '';
}

/********** YDKJMode **********/

function YDKJMode(game, modename, options) {
  this.modename = modename;
  this.game = game;
  this.options = options;
  var thisMode = this;
  
  // preload
  if (this.modename == 'Intro') {
    this.IntroPreTitle = new YDKJResource('Intro/IntroPreTitle');
    this.IntroJack = new YDKJResource('Intro/IntroJack');
    
    this.MusicJack = new YDKJResource('Intro/MusicJack');
    this.SFXBang = new YDKJResource('Intro/SFXBang');
    this.SFXJackTitle = new YDKJResource('Intro/SFXJackTitle');
    this.IntroJackTitle = new YDKJResource('Intro/IntroJackTitle');
    this.IntroJackDemo = new YDKJResource('Intro/IntroJackDemo');
  }
  
  if (this.modename == 'Category') {
    this.SFXShowCategoryScreen = new YDKJResource('Category/SFXShowCategoryScreen');
    
    this.MusicChooseCategoryStart = new YDKJResource('Category/MusicChooseCategoryStart');
    this.MusicChooseCategoryLoop = new YDKJResource('Category/MusicChooseCategoryLoop');
    this.ShowCategories = new YDKJResource('Category/ShowCategories');
    
    this.MusicChooseCategoryStart.ended(function(){
      thisMode.MusicChooseCategoryLoop.playResource();
    });
    
    if (this.options.category == 1) this.ChooseCategory = new YDKJResource('Category/ChooseCategory1');
    if (this.options.category == 2) this.ChooseCategory = new YDKJResource('Category/ChooseCategory2');
    if (this.options.category == 3) this.ChooseCategory = new YDKJResource('Category/ChooseCategory3');
    this.ChooseCategoryText = new YDKJResource('Category/ChooseCategoryText');

    this.ChooseCategoryPlayer1 = new YDKJResource('Category/ChooseCategoryPlayer1');
    this.ChooseCategoryPlayer2 = new YDKJResource('Category/ChooseCategoryPlayer2');
    this.ChooseCategoryPlayer3 = new YDKJResource('Category/ChooseCategoryPlayer3');
    
    this.SFXChoiceCategory = new YDKJResource('Category/SFXChoiceCategory');
    
    this.LoopCategory1 = new YDKJResource('Category/LoopCategory1');
    this.LoopCategory2 = new YDKJResource('Category/LoopCategory2');
    this.LoopCategory3 = new YDKJResource('Category/LoopCategory3');
    this.ChoiceCategory1 = new YDKJResource('Category/ChoiceCategory1');
    this.ChoiceCategory2 = new YDKJResource('Category/ChoiceCategory2');
    this.ChoiceCategory3 = new YDKJResource('Category/ChoiceCategory3');
    
    // Précharger les questions avec l'interface de catégorie
    this.questiontitles = ['Keuf you !', 'Ma meilleure boum', 'C’est dur vraiment plus longtemps'];
    this.question1 = new YDKJMode(this.game, 'Question', {category:this.options.category,questionnumber:this.options.questionnumber,res:'QFold1/ABB', correctanswer:3}); // Preload des questions suivantes
    this.question2 = new YDKJMode(this.game, 'Question', {category:this.options.category,questionnumber:this.options.questionnumber,res:'QFold1/ABE', correctanswer:3});
    this.question3 = new YDKJMode(this.game, 'Question', {category:this.options.category,questionnumber:this.options.questionnumber,res:'QFold1/AJM', correctanswer:4});
  }
  
  if (this.modename == 'Question') {
    if (this.options.questionnumber == 1) {
      this.JingleQuestion = new YDKJResource('Category/JingleQuestion1'); // Charger les bonnes ressources en fonction du n° de la question
      this.BGQuestion = new YDKJResource('Category/BGQuestion1');
    }
    if (this.options.questionnumber == 2) {
      this.JingleQuestion = new YDKJResource('Category/JingleQuestion2');
      this.BGQuestion = new YDKJResource('Category/BGQuestion2');
    }
    if (this.options.questionnumber >= 3) {
      this.JingleQuestion = new YDKJResource('Category/JingleQuestion3');
      this.BGQuestion = new YDKJResource('Category/BGQuestion3');
    }
    
    this.value = 2000;
    
    this.AnnounceCategory = new YDKJResource('Question/AnnounceCategory');
    this.AnnounceValue = new YDKJResource('Question/AnnounceValue'+this.value+'F');
    this.VoiceAnnounceValue = new YDKJResource('Question/VoiceAnnounceValue'+this.value+'F');
    this.HideValue = new YDKJResource('Question/HideValue2000F');
    this.TimerComesIn = new YDKJResource('Question/TimerComesIn1'); // 1 ou 2 au hasard ? Ou spécifique à un type de question ?
    this.PrepareTimer = new YDKJResource('Question/PrepareTimer');
    this.SFXShowQuestion = new YDKJResource('Question/SFXShowQuestion');
    this.JingleReadQuestion = new YDKJResource('Question/JingleReadQuestion');
    this.JingleTimer = new YDKJResource('Question/JingleTimer');
    this.TimeOut = new YDKJResource('Question/TimeOut');
    this.SFXTimeOut = new YDKJResource('Question/SFXTimeOut');
    this.SFXPlayerBuzz = new YDKJResource('Question/SFXPlayerBuzz');
    this.SFXPlayerKey = new YDKJResource('Question/SFXPlayerKey');
    this.SFXPlayerWrong1 = new YDKJResource('Question/SFXPlayerWrong1'); // On efface la réponse
    this.SFXPlayerWrong2 = new YDKJResource('Question/SFXPlayerWrong2'); // On fait tomber le joueur
    this.SFXPlayerCorrect = new YDKJResource('Question/SFXPlayerCorrect');
    this.SFXRevealAnswer = new YDKJResource('Question/SFXRevealAnswer');
    this.DefaultRevealAnswer = new YDKJResource('Question/DefaultRevealAnswer');
    this.DefaultRevealLastAnswer = new YDKJResource('Question/DefaultRevealLastAnswer');
    
    this.ShowPlayer1Key = new YDKJResource('Question/ShowPlayer1Key');
	  this.Player1Answer = new YDKJResource('Question/Player1Answer');
	  this.Player1AnswerLoop = new YDKJResource('Question/Player1AnswerLoop');
    this.PlayerBuzzedPlayer1 = new YDKJResource('Question/PlayerBuzzedPlayer1');
	  this.Player1Correct = new YDKJResource('Question/Player1Correct');
	  this.Player1Wrong = new YDKJResource('Question/Player1Wrong');
	  this.Player1Cancel = new YDKJResource('Question/Player1Cancel');
	  
	  this.ShowPlayer2Key = new YDKJResource('Question/ShowPlayer2Key');
	  this.Player2Answer = new YDKJResource('Question/Player2Answer');
	  this.Player2AnswerLoop = new YDKJResource('Question/Player2AnswerLoop');
    this.PlayerBuzzedPlayer2 = new YDKJResource('Question/PlayerBuzzedPlayer2');
	  this.Player2Correct = new YDKJResource('Question/Player2Correct');
	  this.Player2Wrong = new YDKJResource('Question/Player2Wrong');
	  this.Player2Cancel = new YDKJResource('Question/Player2Cancel');
	  
	  this.ShowPlayer3Key = new YDKJResource('Question/ShowPlayer3Key');
	  this.Player3Answer = new YDKJResource('Question/Player3Answer');
	  this.Player3AnswerLoop = new YDKJResource('Question/Player3AnswerLoop');
    this.PlayerBuzzedPlayer3 = new YDKJResource('Question/PlayerBuzzedPlayer3');
	  this.Player3Correct = new YDKJResource('Question/Player3Correct');
	  this.Player3Wrong = new YDKJResource('Question/Player3Wrong');
	  this.Player3Cancel = new YDKJResource('Question/Player3Cancel');
	  
	  this.NumberAnswer1 = new YDKJResource('Question/NumberAnswer1');
	  this.NumberAnswer2 = new YDKJResource('Question/NumberAnswer2');
	  this.NumberAnswer3 = new YDKJResource('Question/NumberAnswer3');
	  this.NumberAnswer4 = new YDKJResource('Question/NumberAnswer4');
	  this.LoopAnswer1 = new YDKJResource('Question/LoopAnswer1');
	  this.LoopAnswer2 = new YDKJResource('Question/LoopAnswer2');
	  this.LoopAnswer3 = new YDKJResource('Question/LoopAnswer3');
	  this.LoopAnswer4 = new YDKJResource('Question/LoopAnswer4');
	  this.CorrectAnswer1 = new YDKJResource('Question/CorrectAnswer1');
	  this.CorrectAnswer2 = new YDKJResource('Question/CorrectAnswer2');
	  this.CorrectAnswer3 = new YDKJResource('Question/CorrectAnswer3');
	  this.CorrectAnswer4 = new YDKJResource('Question/CorrectAnswer4');
	  this.WrongAnswer1 = new YDKJResource('Question/WrongAnswer1');
	  this.WrongAnswer2 = new YDKJResource('Question/WrongAnswer2');
	  this.WrongAnswer3 = new YDKJResource('Question/WrongAnswer3');
	  this.WrongAnswer4 = new YDKJResource('Question/WrongAnswer4');
    
    this.LastPlayer1 = new YDKJResource('Question/LastPlayer1');
		this.LastPlayer2 = new YDKJResource('Question/LastPlayer2');
		this.LastPlayer3 = new YDKJResource('Question/LastPlayer3');
		this.LastPlayers12 = new YDKJResource('Question/LastPlayers12');
		this.LastPlayers13 = new YDKJResource('Question/LastPlayers13');
		this.LastPlayers23 = new YDKJResource('Question/LastPlayers23');
    
    this.strjs = getYDKJFile('js','res/'+this.options.res+'/STR.js');
    this.correctanswer = this.options.correctanswer;
    
    this.QuestionTitle = new YDKJAnimation('','','res/'+this.options.res+'/snd/1');
    this.PreQuestion = new YDKJAnimation('','','res/'+this.options.res+'/snd/2');
    this.Question = new YDKJAnimation('','','res/'+this.options.res+'/snd/3');
    this.Answers = new YDKJAnimation('','','res/'+this.options.res+'/snd/5');
    this.EndQuestion = new YDKJAnimation('','','res/'+this.options.res+'/snd/6');
    this.Answer1 = new YDKJAnimation('','','res/'+this.options.res+'/snd/7');
    this.Answer2 = new YDKJAnimation('','','res/'+this.options.res+'/snd/8');
    this.Answer3 = new YDKJAnimation('','','res/'+this.options.res+'/snd/9');
    this.Answer4 = new YDKJAnimation('','','res/'+this.options.res+'/snd/10');
    this.RevealAnswer = new YDKJAnimation('','','res/'+this.options.res+'/snd/11');
  }
}

YDKJMode.prototype.start = function() {
  var thisMode = this;
  if (this.game.currentmode) this.game.currentmode.free();
  this.game.currentmode = this;
  this.skiplistener = 0;
  
  if (this.modename == 'Intro') {
    this.IntroJackDemo.ended(function(){
      this.free();
      thisMode.IntroJackDemo.delay(function(){
        thisMode.MusicJack.free();
        thisMode.IntroJack.free();
        if (this.skiplistener) unbindKeyListener(this.skiplistener);
        thisMode.category.start(); // On passe au choix de la catégorie
      },300);
    });
    
    this.IntroJackTitle.ended(function(){
      this.free();
      thisMode.IntroJackDemo.delay(function(){
        this.playResource();
        thisMode.category = new YDKJMode(thisMode.game, 'Category', {category:1,questionnumber:1}); // Preload des catégories pendant le speech
        this.skiplistener = bindKeyListener(function(choice) {
          unbindKeyListener(thisMode.skiplistener);
          if (choice == 32) thisMode.category.start(); // Barre espace = on passe au choix de la catégorie
        });
      },300);
    });
    
    this.SFXJackTitle.ended(function(){
      this.free();
      thisMode.IntroJackTitle.delay(function(){
        thisMode.MusicJack.animation.setVolume(50); // On baisse le volume de la musique de fond
        this.playResource();
      },300);
    });
    
    this.SFXBang.ended(function(){
      this.free();
      thisMode.SFXJackTitle.delay(function(){this.playResource()},300);
    });
    
    var playerNamesPos = 0;
    var actualPlayer = 0;
    this.IntroJack.setAnimCallback(function(){
      if (playerNamesPos % 3 == 0) {
        actualPlayer = thisMode.game.displayPlayer(Math.floor(playerNamesPos/3)+1);
        actualPlayer.css({'opacity':'0.33'}).show();
      } else {
        if (playerNamesPos % 3 == 1) actualPlayer.css({'opacity':'0.66'});
        else actualPlayer.css({'opacity':1});
      }
      playerNamesPos++;
    });
    
    this.IntroPreTitle.ended(function(){
      thisMode.IntroJack.playResource();
      this.free();
      thisMode.MusicJack.playResource();
      thisMode.SFXBang.delay(function(){this.playResource()},300);
    });
    
    this.IntroPreTitle.playResource();
  }
  
  if (this.modename == 'Category') {
    if (!this.chooseplayer) this.chooseplayer = 3; // Déterminer un joueur qui pourra choisir la catégorie
    
    if (this.chooseplayer == 1) this.ChooseCategoryPlayer = this.ChooseCategoryPlayer1;
    if (this.chooseplayer == 2) this.ChooseCategoryPlayer = this.ChooseCategoryPlayer2;
    if (this.chooseplayer == 3) this.ChooseCategoryPlayer = this.ChooseCategoryPlayer3;
    
    this.SFXChoiceCategory.ended(function(){
      thisMode.SFXChoiceCategory.free();
      thisMode.SFXChoiceCategory = new YDKJResource('Category/SFXChoiceCategory');
      thisMode.ChooseCategoryPlayer.delay(function(){
        this.playResource();
        var thisChooseCategory = this;
        
        var listener = bindKeyListener(function(choice) {
          var chosed = 0;
          var nextquestion = 0;
          if (choice == 49) chosed = 1;
          else if (choice == 50) chosed = 2;
          else if (choice == 51) chosed = 3;
          else if (choice == -1) { // Timeout
            // A gérer
          } else chosed = 0;
          if (chosed) {
          	var choice, nextquestion;
          	switch(chosed) {
          		case 1:
          			choice = thisMode.ChoiceCategory1;
          			nextquestion = thisMode.question1;
          		break;
          		case 2:
          			choice = thisMode.ChoiceCategory2;
          			nextquestion = thisMode.question2;
          		break;
          		case 3:
          			choice = thisMode.ChoiceCategory3;
          			nextquestion = thisMode.question3;
          		break;
          	}
            unbindKeyListener(listener);
            jQuery('#screen .QuestionTitle:not(#QuestionTitle'+(chosed-1)+')').remove();
            thisChooseCategory.free();
            thisMode.MusicChooseCategoryLoop.free();
            thisMode.LoopCategory1.free();
            thisMode.LoopCategory2.free();
            thisMode.LoopCategory3.free();
            
            thisMode.SFXChoiceCategory.ended(function(){
              thisMode.ChooseCategory.free();
              thisMode.ChooseCategoryText.free();
              choice.free();
              nextquestion.start(); // On démarre la question choisie
            });
            
            thisMode.SFXChoiceCategory.playResource();
            choice.playResource();
          }
        },10000); // 10 secondes de timeout
      },100);
    });
    
    this.ChooseCategoryText.ended(function(){
      jQuery('<div />').css({
        'position':'absolute',
        'width':'320px',
        'left':'270px',
        'top':'67px',
        'font-family':'JackRoman',
        'font-size':'32px',
        'color':'#000',
        'text-align':'center',
        'opacity':'0.15'
      }).html(thisMode.game.players[thisMode.chooseplayer-1].name).appendTo('#screen');
      jQuery('<div />').css({
        'position':'absolute',
        'width':'320px',
        'left':'288px',
        'top':'85px',
        'font-family':'JackRoman',
        'font-size':'32px',
        'color':'#000',
        'text-align':'center',
        'opacity':'0.40'
      }).html(thisMode.game.players[thisMode.chooseplayer-1].name).appendTo('#screen');
      jQuery('<div />').css({
        'position':'absolute',
        'width':'320px',
        'left':'280px',
        'top':'75px',
        'font-family':'JackRoman',
        'font-size':'32px',
        'color':'#FFF',
        'text-align':'center',
      }).html(thisMode.game.players[thisMode.chooseplayer-1].name).appendTo('#screen');
    });
    
    this.ShowCategories.ended(function(){
      thisMode.SFXChoiceCategory.delay(function(){
        this.playResource();
        thisMode.ChooseCategoryText.playResource();
        thisMode.LoopCategory1.playResource();
        thisMode.LoopCategory2.playResource();
        thisMode.LoopCategory3.playResource();
        thisMode.ShowCategories.free();
      },300);
    });
    
    var ShowCategoryNum = 0;
    this.ShowCategories.setAnimCallback(function(){
    	if (ShowCategoryNum < 3) {
    		var title = thisMode.questiontitles[ShowCategoryNum];
    		var div = jQuery('<div />').addClass('QuestionTitle').attr('id','QuestionTitle'+ShowCategoryNum).css({ // Titre de la catégorie
	  			'position':'absolute',
	  			'width':'0px',
	  			'height':'100px',
	  			'line-height':'100px',
	  			'left':'130px',
	  			'top':(163+100*ShowCategoryNum)+'px',
	  			'overflow':'hidden'
	  		});
	  		
	  		jQuery('<div />').css({
	  			'width':'500px',
	  			'vertical-align':'middle',
  				'display':'inline-block',
	  			'font-size':'32px',
	  			'line-height':'32px',
	  			'color':'#FC0',
	  			'font-family':'JackRoman'
	  		}).html(title).appendTo(div);
	  		
	  		div.appendTo('#screen').animate({'width':'500px'},150);
	      
    		ShowCategoryNum++;
    	}
    });
    
    this.ChooseCategory.ended(function(){
      thisMode.ShowCategories.delay(function(){
        this.playResource();
      },300);
    });
    
    this.SFXShowCategoryScreen.ended(function(){
      if ((!thisMode.MusicChooseCategoryStart.isplaying) && (!thisMode.MusicChooseCategoryLoop.isplaying)) thisMode.MusicChooseCategoryStart.playResource();
    });
    
    this.SFXShowCategoryScreen.playResource();
    // Jouer l'animation du zoom bleu
    
    var blueZoom = function() {
      var step=0;
      var sizes=[{x:40,y:30}, // Tailles d'origine du jeu, svp
                 {x:80,y:60},
                 {x:160,y:120},
                 {x:240,y:180},
                 {x:320,y:240},
                 {x:400,y:300},
                 {x:480,y:360},
                 {x:560,y:420},
                 {x:640,y:480}];
      var blueDiv = jQuery('<div />').css('z-index','2000').addClass('markedAsRemoved');
      blueDiv.appendTo(jQuery('#screen'));
      var interval = 0;
      var nextStep = function() {
        if (step < 9) {
          blueDiv.css({
            'background-color':'#00C',
            'width':(sizes[step].x)+'px',
            'height':(sizes[step].y)+'px',
            'position':'absolute',
            'left':Math.round((640-sizes[step].x)/2)+'px',
            'top':Math.round((480-sizes[step].y)/2)+'px',
          });
          step++;
        } else {
          clearInterval(interval);
          jQuery('#screen').css('background-color','#00C').html('');
          thisMode.ChooseCategory.playResource();
        }
      }
      interval=setInterval(nextStep,40);
    }
    
    blueZoom();
  }
  
  if (this.modename == 'Question') {
    var nextcategory = 0;

    this.EndQuestion.ended(function(){
      nextcategory.MusicChooseCategoryStart.delay(function(){
        nextcategory.start();
      },200);
    });
    
    this.SFXPlayerCorrect.ended(function(){
      thisMode.availPlayers[thisMode.currentPlayer].css({'color':'#0F0'});
      this.delay(function(){
        nextcategory.chooseplayer = thisMode.currentPlayer; // On donne le choix au joueur qui a bien répondu
        nextcategory.MusicChooseCategoryStart.playResource();
        this.delay(function(){
          thisMode.EndQuestion.playAnim();
        },300);
      },300);
    });
    
    this.SFXRevealAnswer.ended(function(){
      this.delay(function(){
        var answer;
        if (thisMode.correctanswer == 1) answer = thisMode.Answer1;
        if (thisMode.correctanswer == 2) answer = thisMode.Answer2;
        if (thisMode.correctanswer == 3) answer = thisMode.Answer3;
        if (thisMode.correctanswer == 4) answer = thisMode.Answer4;
        answer.ended(function(){
          thisMode.SFXRevealAnswer.delay(function(){
            thisMode.EndQuestion.playAnim();
          },200);
        });
        this.delay(function(){
          answer.playAnim();
        },200);
        nextcategory.MusicChooseCategoryStart.playResource();
      },300);
    });
    
    var gameover = function() {
      // Plus aucun joueur ne peut jouer (timer ou tous les joueurs ont participé)
      unbindKeyListener(thisMode.listener);
      
      var revealAnswer;
      var nbAns = 0;
      for(i=1;i<=4;i++) if (thisMode.availAnswers[i]) nbAns++;
      if (nbAns == 1) revealAnswer = thisMode.DefaultRevealLastAnswer;
      else revealAnswer = thisMode.DefaultRevealAnswer;
      
      revealAnswer.ended(function() {
        this.delay(function(){
          thisMode.NumberAnswer1.free();
          thisMode.NumberAnswer2.free();
          thisMode.NumberAnswer3.free();
          thisMode.NumberAnswer4.free();
          jQuery('#screen .markedAsRemoved').remove();
          for(i=1;i<=4;i++) if (thisMode.availAnswers[i]) thisMode.availAnswers[i].remove();
          
      		var div = jQuery('<div />').css({ // Réponse
      			'position':'absolute',
      			'height':'120px',
      			'line-height':'120px',
      			'left':'50px',
      			'top':'220px',
      		}).appendTo('#screen');
      		
          jQuery('<div />').css({
            'position':'relative',
      			'vertical-align':'middle',
    				'display':'inline-block',
            'font-family':'JackRoman',
            'color':'#FC0',
            'text-align':'center',
            'width':'540px',
            'font-size':'44px',
            'line-height':'44px'
          }).html(getSTRfromID(thisMode.STR,thisMode.correctanswer+2)).appendTo(div);
          
          thisMode.SFXRevealAnswer.playResource();
        },300);
      });
      
      revealAnswer.playResource();
    }
    
    this.SFXPlayerWrong2.ended(function(){
      thisMode.JingleTimer.delay(function(){
        thisMode.availPlayers[thisMode.currentPlayer].css({'color':'#F00'});
        thisMode.availPlayers[thisMode.currentPlayer] = 0;
        if (thisMode.currentAns) thisMode.availAnswers[thisMode.currentAns] = 0;
        thisMode.currentPlayer = 0;
        thisMode.currentAns = 0;
        
        if (thisMode.availPlayers[1]) {
          if (thisMode.availPlayers[2]) thisMode.LastPlayers = thisMode.LastPlayers12;
          else if (thisMode.availPlayers[3]) thisMode.LastPlayers = thisMode.LastPlayers13;
          else thisMode.LastPlayers = thisMode.LastPlayer1;
        } else if (thisMode.availPlayers[2]) {
          if (thisMode.availPlayers[3]) thisMode.LastPlayers = thisMode.LastPlayers23;
          else thisMode.LastPlayers = thisMode.LastPlayer2;
        } else if (thisMode.availPlayers[3]) {
          thisMode.LastPlayers = thisMode.LastPlayer3;
        } else {
          // Plus aucun joueur
          thisMode.LastPlayers = 0;
          gameover();
        }
        
        if (thisMode.LastPlayers)  {
          this.playResource();
          thisMode.LastPlayers.playResource();
        }
      },200);
    });
    
    var wrong1 = function(){
      thisMode.SFXPlayerWrong2.delay(function() {
        var currentPlayer = thisMode.currentPlayer;
        thisMode.game.players[currentPlayer-1].score -= thisMode.value;
        thisMode.availPlayers[currentPlayer].find('.score').html(thisMode.game.players[currentPlayer-1].score+' F');
        
        var PlayerWrong, PlayerAnswerLoop;
        switch (currentPlayer) {
          case 1:
            PlayerWrong = thisMode.Player1Wrong;
            PlayerAnswerLoop = thisMode.Player1AnswerLoop;
          break;
          case 2:
            PlayerWrong = thisMode.Player2Wrong;
            PlayerAnswerLoop = thisMode.Player2AnswerLoop;
          break;
          case 3:
            PlayerWrong = thisMode.Player3Wrong;
            PlayerAnswerLoop = thisMode.Player3AnswerLoop;
          break;
        }
        
        PlayerWrong.ended(function(){
          if (thisMode.availPlayers[currentPlayer]) thisMode.availPlayers[currentPlayer].css({'color':'#F00'});
        });
        
        PlayerWrong.playResource();
        PlayerAnswerLoop.free();
        this.playResource();
      },100);
    }
    
    this.WrongAnswer1.ended(wrong1);
    this.WrongAnswer2.ended(wrong1);
    this.WrongAnswer3.ended(wrong1);
    this.WrongAnswer4.ended(wrong1);
    this.TimeOut.ended(wrong1);

    this.SFXTimeOut.ended(function(){
      this.delay(function(){
        if (thisMode.currentPlayer) {
          thisMode.TimeOut.playResource();
        } else {
          gameover();
        }
      },500);
    });

    this.JingleTimer.ended(function(){
      this.delay(function(){
        thisMode.SFXTimeOut.playResource();
      },200);
    });
    
    var checkAnswer = function(){
      if (thisMode.currentPlayer == 0) return true;
      if (thisMode.currentAns != thisMode.correctanswer) { // Mauvaise réponse
        switch(thisMode.currentAns){
          case 1:
            thisMode.WrongAnswer1.playResource();
            thisMode.LoopAnswer1.free();
          break;
          case 2:
            thisMode.WrongAnswer2.playResource();
            thisMode.LoopAnswer2.free();
          break;
          case 3:
            thisMode.WrongAnswer3.playResource();
            thisMode.LoopAnswer3.free();
          break;
          case 4:
            thisMode.WrongAnswer4.playResource();
            thisMode.LoopAnswer4.free();
          break;
        }
        animTransform(thisMode.availAnswers[thisMode.currentAns],1,0,1,1,0.18,thisMode.availAnswers[thisMode.currentAns].width(),0);
        thisMode.SFXPlayerWrong1.playResource();
      } else { // Bonne réponse
        switch(thisMode.currentAns){
          case 1:
            thisMode.CorrectAnswer1.playResource();
            thisMode.LoopAnswer1.free();
          break;
          case 2:
            thisMode.CorrectAnswer2.playResource();
            thisMode.LoopAnswer2.free();
          break;
          case 3:
            thisMode.CorrectAnswer3.playResource();
            thisMode.LoopAnswer3.free();
          break;
          case 4:
            thisMode.CorrectAnswer4.playResource();
            thisMode.LoopAnswer4.free();
          break;
        }
        switch (thisMode.currentPlayer) {
          case 1:
            thisMode.Player1Correct.playResource();
            thisMode.Player1AnswerLoop.free();
          break;
          case 2:
            thisMode.Player2Correct.playResource();
            thisMode.Player2AnswerLoop.free();
          break;
          case 3:
            thisMode.Player3Correct.playResource();
            thisMode.Player3AnswerLoop.free();
          break;
        }
        
        thisMode.game.players[thisMode.currentPlayer-1].score += thisMode.value;
        thisMode.availPlayers[thisMode.currentPlayer].find('.score').html(thisMode.game.players[thisMode.currentPlayer-1].score+' F');

        thisMode.SFXPlayerCorrect.playResource();
        unbindKeyListener(thisMode.listener);
      }
    };
    
    this.Answer1.ended(checkAnswer);
    this.Answer2.ended(checkAnswer);
    this.Answer3.ended(checkAnswer);
    this.Answer4.ended(checkAnswer);
    
    this.Player1Answer.ended(function(){
      thisMode.Player1AnswerLoop.playResource();
      this.free();
    });
    this.Player2Answer.ended(function(){
      thisMode.Player2AnswerLoop.playResource();
      this.free();
    });
    this.Player3Answer.ended(function(){
      thisMode.Player3AnswerLoop.playResource();
      this.free();
    });
    
    this.SFXPlayerBuzz.ended(function(){
      this.delay(function(){
        // Remise du compteur à 10
        thisMode.JingleTimer.playResource();
        
        // Vas-y joueur X
        if (thisMode.currentPlayer == 1) {
          thisMode.PlayerBuzzedPlayer1.playResource();
        }
        if (thisMode.currentPlayer == 2) {
          thisMode.PlayerBuzzedPlayer2.playResource();
        }
        if (thisMode.currentPlayer == 3) {
          thisMode.PlayerBuzzedPlayer3.playResource();
        }
      },150);
    });
    
    this.Answers.ended(function(){
      this.free();
      thisMode.JingleReadQuestion.delay(function(){
        thisMode.JingleReadQuestion.free();
        thisMode.JingleTimer.playResource();
      },100);
    });
    
    this.Question.ended(function(){
      this.free();
      thisMode.JingleReadQuestion.delay(function(){
        thisMode.Answers.playAnim();
      },100);
    });
    
    thisMode.PrepareTimer.ended(function(){
      this.delay(function(){
        thisMode.NumberAnswer1.playResource();
        thisMode.NumberAnswer2.playResource();
        thisMode.NumberAnswer3.playResource();
        thisMode.NumberAnswer4.playResource();
        
        var div1 = jQuery('<div />').css({ // Réponse 1
    			'position':'absolute',
    			'left':'138px',
    			'top':'223px',
    			'width':'500px'
    		}).appendTo('#screen');
        var ans1 = jQuery('<div />').css({
    			'position':'absolute',
    			'left':'150px',
    			'font-size':'26px',
    			'color':'#FC0',
    			'font-family':'JackCondensed',
  				'-webkit-transform':'scale(1.0, 0.0)',
      		'-moz-transform':'scale(1.0, 0.0)',
      		'-ms-transform':'scale(1.0, 0.0)',
      		'-o-transform':'scale(1.0, 0.0)',
      		'transform':'scale(1.0, 0.0)',
    		}).html(getSTRfromID(thisMode.STR,3)).appendTo(div1);
        animTransform(ans1,1,1,0,1,0.10,0,26);
        
        var div2 = jQuery('<div />').css({ // Réponse 2
    			'position':'absolute',
    			'left':'138px',
    			'top':'255px',
    			'width':'500px'
    		}).appendTo('#screen');
        var ans2 = jQuery('<div />').css({
    			'position':'absolute',
    			'left':'150px',
    			'font-size':'26px',
    			'color':'#FC0',
    			'font-family':'JackCondensed',
  				'-webkit-transform':'scale(1.0, 0.0)',
      		'-moz-transform':'scale(1.0, 0.0)',
      		'-ms-transform':'scale(1.0, 0.0)',
      		'-o-transform':'scale(1.0, 0.0)',
      		'transform':'scale(1.0, 0.0)',
    		}).html(getSTRfromID(thisMode.STR,4)).appendTo(div2);
        animTransform(ans2,1,1,0,1,0.10,0,26);
        
        var div3 = jQuery('<div />').css({ // Réponse 3
    			'position':'absolute',
    			'left':'138px',
    			'top':'286px',
    			'width':'500px'
    		}).appendTo('#screen');
        var ans3 = jQuery('<div />').css({
    			'position':'absolute',
    			'left':'150px',
    			'font-size':'26px',
    			'color':'#FC0',
    			'font-family':'JackCondensed',
  				'-webkit-transform':'scale(1.0, 0.0)',
      		'-moz-transform':'scale(1.0, 0.0)',
      		'-ms-transform':'scale(1.0, 0.0)',
      		'-o-transform':'scale(1.0, 0.0)',
      		'transform':'scale(1.0, 0.0)',
    		}).html(getSTRfromID(thisMode.STR,5)).appendTo(div3);
        animTransform(ans3,1,1,0,1,0.10,0,26);
        
        var div4 = jQuery('<div />').css({ // Réponse 4
    			'position':'absolute',
    			'left':'138px',
    			'top':'318px',
    			'width':'500px'
    		}).appendTo('#screen');
        var ans4 = jQuery('<div />').css({
    			'position':'absolute',
    			'left':'150px',
    			'font-size':'26px',
    			'color':'#FC0',
    			'font-family':'JackCondensed',
  				'-webkit-transform':'scale(1.0, 0.0)',
      		'-moz-transform':'scale(1.0, 0.0)',
      		'-ms-transform':'scale(1.0, 0.0)',
      		'-o-transform':'scale(1.0, 0.0)',
      		'transform':'scale(1.0, 0.0)',
    		}).html(getSTRfromID(thisMode.STR,6)).appendTo(div4);
        animTransform(ans4,1,1,0,1,0.10,0,26);
        
        thisMode.availAnswers = new Array();
        thisMode.availAnswers[1] = ans1;
        thisMode.availAnswers[2] = ans2;
        thisMode.availAnswers[3] = ans3;
        thisMode.availAnswers[4] = ans4;
        
        thisMode.currentPlayer = 0;
        thisMode.currentAns = 0;
        thisMode.listener = bindKeyListener(function(choice) {
          if (thisMode.currentPlayer == 0) {
            if (choice == 113) thisMode.currentPlayer = 1; // Joueur 1
            if (choice == 98) thisMode.currentPlayer = 2; // Joueur 2
            if (choice == 112) thisMode.currentPlayer = 3; // Joueur 3
            if (!thisMode.availPlayers[thisMode.currentPlayer]) thisMode.currentPlayer = 0;
            
            // Si réponses 1 à 4 : 1 seul joueur = réponse directe, 2 ou 3 joueurs : "On appuie d'abord sur la lettre !"
            
            if (thisMode.currentPlayer) {
              thisMode.Question.free();
              thisMode.Answers.free();
              thisMode.JingleReadQuestion.free();
              if (thisMode.LastPlayers) thisMode.LastPlayers.free();
              thisMode.JingleTimer.stopResource();
              thisMode.SFXPlayerBuzz.playResource();
              switch (thisMode.currentPlayer) {
                case 1:
                  thisMode.Player1Answer.playResource();
                  thisMode.ShowPlayer1Key.free();
                break;
                case 2:
                  thisMode.Player2Answer.playResource();
                  thisMode.ShowPlayer2Key.free();
                break;
                case 3:
                  thisMode.Player3Answer.playResource();
                  thisMode.ShowPlayer3Key.free();
                break;
              }
            }
          } else if (thisMode.currentAns == 0) { // Réponse d'un joueur
            if (choice == 49) thisMode.currentAns = 1;
            if (choice == 50) thisMode.currentAns = 2;
            if (choice == 51) thisMode.currentAns = 3;
            if (choice == 52) thisMode.currentAns = 4;
            if (!thisMode.availAnswers[thisMode.currentAns]) thisMode.currentAns = 0;
            
            if (thisMode.currentAns) {
              thisMode.SFXPlayerKey.ended(function(){
                this.delay(function(){
                  thisMode.SFXPlayerKey = new YDKJResource('Question/SFXPlayerKey');
                  this.free();
                  switch(thisMode.currentAns){
                    case 1:
                      thisMode.Answer1.playAnim();
                    break;
                    case 2:
                      thisMode.Answer2.playAnim();
                    break;
                    case 3:
                      thisMode.Answer3.playAnim();
                    break;
                    case 4:
                      thisMode.Answer4.playAnim();
                    break;
                  }
                },150);
              });
              switch (thisMode.currentPlayer) {
                case 1:
                  thisMode.PlayerBuzzedPlayer1.free();
                break;
                case 2:
                  thisMode.PlayerBuzzedPlayer2.free();
                break;
                case 3:
                  thisMode.PlayerBuzzedPlayer3.free();
                break;
              }
              switch(thisMode.currentAns){
                case 1:
                  thisMode.LoopAnswer1.playResource();
                  thisMode.NumberAnswer1.free();
                break;
                case 2:
                  thisMode.LoopAnswer2.playResource();
                  thisMode.NumberAnswer2.free();
                break;
                case 3:
                  thisMode.LoopAnswer3.playResource();
                  thisMode.NumberAnswer3.free();
                break;
                case 4:
                  thisMode.LoopAnswer4.playResource();
                  thisMode.NumberAnswer4.free();
                break;
              }
              thisMode.JingleTimer.stopResource();
              thisMode.SFXPlayerKey.playResource();
            }
          }
        });
        
      },1000);
    });
    
    this.SFXShowQuestion.ended(function(){
      this.delay(function(){
        thisMode.TimerComesIn.free();
        thisMode.PrepareTimer.playResource();
      },500);
    });
    
  	this.TimerComesIn.ended(function(){
  		var div = jQuery('<div />').css({ // Titre de la catégorie
  			'position':'absolute',
  			'height':'70px',
  			'line-height':'70px',
  			'left':'70px',
  			'top':'0'
  		});
  		
  		var titlediv = jQuery('<div />').css({
  			'position':'relative',
  			'left':'-150px',
  			'width':'300px',
  			'vertical-align':'middle',
				'display':'inline-block',
  			'font-size':'20px',
  			'line-height':'24px',
  			'color':'#33F',
  			'font-family':'JackRoman',
				'-webkit-transform':'scale(0.0, 1.0)',
    		'-moz-transform':'scale(0.0, 1.0)',
    		'-ms-transform':'scale(0.0, 1.0)',
    		'-o-transform':'scale(0.0, 1.0)',
    		'transform':'scale(0.0,1.0)',
  		}).html(getSTRfromID(thisMode.STR,1)).appendTo(div);
  		
  		div.appendTo('#screen');
  		
  		animTransform(titlediv,0,1,1,1,0.15,300,0,function(){
  		  thisMode.PreQuestion.ended(function(){
				  this.free();
				  
      		var div = jQuery('<div />').css({ // Texte de la question
      			'position':'absolute',
      			'height':'150px',
      			'line-height':'150px',
      			'left':'-560px',
      			'top':'70px'
      		});
      		
      		var textdiv = jQuery('<div />').css({
      			'position':'relative',
      			'width':'560px',
      			'vertical-align':'middle',
    				'display':'inline-block',
      			'font-size':'36px',
      			'line-height':'34px',
      			'color':'#FFF',
      			'font-family':'JackExtraCond',
      			'font-style':'italic',
      			'text-align':'center'
      		}).html(getSTRfromID(thisMode.STR,2));
      		
      		textdiv.appendTo(div);
      		
      		div.appendTo('#screen').animate({'left':'40px'},300,function(){textdiv.css({'font-style':'normal'})});
		
          thisMode.SFXShowQuestion.playResource();
          thisMode.JingleReadQuestion.playResource();
          thisMode.JingleReadQuestion.delay(function() {
            thisMode.Question.playAnim();
          },300);
				});

				thisMode.availPlayers = new Array();
				
				thisMode.ShowPlayer1Key.ended(function(){
				  thisMode.availPlayers[1] = thisMode.game.displayPlayer(1).show();
				});
				thisMode.ShowPlayer2Key.ended(function(){
				  thisMode.availPlayers[2] = thisMode.game.displayPlayer(2).show();
				});
				thisMode.ShowPlayer3Key.ended(function(){
				  thisMode.availPlayers[3] = thisMode.game.displayPlayer(3).show();
				});
				
				thisMode.ShowPlayer1Key.delay(function(){
  				this.playResource();
  			  if (thisMode.game.players.length >= 2) thisMode.ShowPlayer2Key.delay(function(){
  			    this.playResource();
  			    if (thisMode.game.players.length == 3) thisMode.ShowPlayer3Key.delay(function(){
  			      this.playResource();
            },100);
  			  },100);
  			},200);
  		});
  		
  		var valuediv = jQuery('<div />').css({ // Valeur de la question
  			'position':'absolute',
  			'text-align':'right',
  			'font-size':'20px',
  			'color':'#33F',
  			'font-family':'JackRoman',
  			'right':'-80px',
  			'top':'22px'
  		}).html(thisMode.value+' F').appendTo('#screen').animate({'right':'20px'}, 500).animate({'right':'15px'}, 200);
  	});
  	
  	this.VoiceAnnounceValue.ended(function(){
  		this.free();
  		thisMode.AnnounceValue.free();
  		jQuery('#screen #QuestionTitle').css('font-style','italic').delay(100).animate({'left':'-500px'},500,function(){
	  		jQuery('#screen #QuestionTitle').remove();
	  		thisMode.TimerComesIn.delay(function(){
	  			this.playResource();
	  		},300);
  		});
  		thisMode.HideValue.playResource();
  		thisMode.VoiceAnnounceValue.delay(function(){
  		  thisMode.PreQuestion.playAnim();
  		},150);
  	});
  	
  	this.QuestionTitle.ended(function(){
  		this.free();
  		thisMode.VoiceAnnounceValue.delay(function() {
  		  this.playResource();
  		},100);
  	});
  	
  	this.AnnounceCategory.ended(function(){
  		var textsize = 70;
  		if (getSTRfromID(thisMode.STR,1).length < 15) textsize = 120;
  		
  		jQuery('<div />').attr('id','QuestionTitle').css({ // Titre de la catégorie
  			'color':'#FFF',
  			'font-family':'JackExtraCond',
  			'text-align':'center',
  			'font-size':Math.round(textsize*0.90)+'px',
  			'line-height':textsize+'px',
  			'position':'absolute',
  			'width':'450px',
  			'left':'95px',
  			'top':Math.round(125+textsize*0.05)+'px',
  			'opacity':'0'
  		}).html(getSTRfromID(thisMode.STR,1)).appendTo('#screen').animate({
  			'top':'125px',
  			'font-size':textsize+'px',
  			'line-height':Math.round(textsize*1.10)+'px',
  			'opacity':'1',
  			'display':'none'}
  		,250,function(){
  		  thisMode.AnnounceValue.delay(function(){
  		    this.playResource();
  		  },150);
  		});
  		thisMode.AnnounceCategory.delay(function(){
  		  thisMode.QuestionTitle.playAnim();
  		},100);
  	});
  	
    this.JingleQuestion.ended(function(){
      thisMode.JingleQuestion.free();
      thisMode.BGQuestion.delay(function(){
        this.playResource();
        thisMode.AnnounceCategory.playResource();
      },100);
    });
    
    jQuery('#screen').css('background-color','#000').html(''); // Je vide manuellement l'écran.
    this.strjs.ready(function(){
    	thisMode.STR = thisMode.strjs.res['STR'];
    	thisMode.JingleQuestion.playResource();
  	});
  	
  	nextcategory = new YDKJMode(this.game, 'Category', {category:1,questionnumber:this.options.questionnumber+1});
  }
}

YDKJMode.prototype.free = function() {
  for (var i in this) {
    if (this[i] instanceof YDKJResource) {
      this[i].free();
      this[i] = undefined;
      delete this[i];
    }
  }
}

/********** YDKJGame **********/

function YDKJGame() {
	jQuery.fx.interval = 66;
  this.players = new Array(
    {name:'Jeff',score:0},
    {name:'David',score:0},
    {name:'Alicia',score:0}
  );
  this.currentmode = 0;
}

YDKJGame.prototype.start = function() {
  //var gamemode = new YDKJMode(this, 'Intro');
  var gamemode = new YDKJMode(this, 'Category', {category:1,questionnumber: 1});
  //var gamemode = new YDKJMode(this, 'Question', {questionnumber:1,res:'QFold1/AJM',correctanswer:4});
  gamemode.start();
}

YDKJGame.prototype.displayPlayer = function(playernumber) {
  var x;
  if (this.players.length == 3) {
    x=[106,320,533];
  }
  
  var playerdiv = jQuery('<div />').css({
    'position':'absolute',
    'z-index':'1000',
    'left':(x[playernumber-1]-100)+'px',
    'top':'400px',
    'width':'200px',
    'text-align':'center',
    'color':'#FFF',
    'font-family':'JackRoman',
    'font-size':'20px',
    'line-height':'30px'
  }).appendTo('#screen');
  
  jQuery('<div />').addClass('name').css({'position':'relative'}).html(this.players[playernumber-1].name).appendTo(playerdiv);
  jQuery('<div />').addClass('score').css({'position':'relative'}).html(this.players[playernumber-1].score+' F').appendTo(playerdiv);
  
  return playerdiv;
}

/********** Début du document **********/

jQuery(document).ready(function() {
  var game = new YDKJGame();
  game.start();
  
  //var anim = new YDKJAnimation('res/5QDemo/off4/10000.gif','res/5QDemo/off4/10000.js','',0,1);
  //anim.ready(function(){anim.playAnim();});
});

/********** Debug **********/

function playqnumber(id,variante) {
  var zid = id;
  if (id < 10) zid = '0'+id;

  var anim = new YDKJAnimation('res/QNUMBERS/off4/-'+variante+zid+'0.gif','res/QNUMBERS/off4/-'+variante+zid+'0.js','res/QNUMBERS/snd/'+id+'00'+(variante+1),0,0);
  anim.ready(function(){anim.playAnim();});

  // id 7,1 : val == 83 qui fait un défaut d'affichage sur celle là...
  // id 9,2 : val == 5 qui fait un défaut d'affichage sur celle là, et 57 aussi...
  // id 15,2 : val == 22
  // id 19,2 : val == 35 sur plusieurs frames qui fait un beau bug
}

</script>
</head>

<body style="background-color:#000;margin:0;padding:0;border:0">
  <div id="screen" style="background-color:#000;position:relative;width:640px;height:480px;overflow:hidden;margin-left:auto;margin-right:auto;margin-top:15px">
    <img src="ajax-loader.gif" style="position:absolute;left:293px;top:212px" class="markedAsRemoved"/>
  </div> <!-- Couleur #EEE pour l'intro -->
  <div id="debuglive" style="display:none;background-color:#000;color:#FFF;padding:5px;margin-top:10px;"><br/></div>
  <div id="debug" style="display:none;background-color:#000;color:#FFF;padding:5px;margin-top:10px;height:150px;overflow-y:scroll"></div>
  <div id="tmpscreen" style="display:none"></div>
  <div id="preload" style="display:none"></div>
</body>
</html>