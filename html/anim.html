<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Test YDKJ</title>
<script src="res/5QDemo/off4/-2030.js" type="text/javascript"></script>
<script src="jquery-1.11.0.min.js" type="text/javascript"></script>
<script type="text/javascript">

// 'fireOne' argument is optional, if set, will invoke the callback once for every
// image in the 'this' collection, thus making 'this' in the callback that element alone
// If it's not used, the callback will be invoked once all the images in the collection has
// been loaded. And 'this' will be the jQuery collection of the filtered 'img' elements.

jQuery.fn.imagesLoaded = function(callback, fireOne) {
  var
    args = arguments,
    elems = this.filter('img'),
    elemsLen = elems.length - 1;

  elems
    .bind('load', function(e) {
        if (fireOne) {
            !elemsLen-- && callback.call(elems, e);
        } else {
            callback.call(this, e);
        }
    }).each(function() {
        // cached images don't fire load sometimes, so we reset src.
        if (this.complete || this.complete === undefined) {
            if (jQuery(this).hasClass('alreadyLoaded')) jQuery(this).trigger('load'); else this.src = this.src;
        }
    });
}

var totalAudio = 0;
function waitForAudio(callback) {
  var elems = jQuery("#preload audio");
  totalAudio = elems.length;
  elems.each(function(){if (this.duration) totalAudio--;});
  if (totalAudio) window.setTimeout(function(){waitForAudio(callback)},50); else callback.call();
}

function newScreen() {
  $('#tmpscreen').html('');
}

function addTile(tileid, x, y) {
  var tmpscreen = $('#tmpscreen');
  var ourtile = tiles[tileid];
  if (!ourtile) return false;
  var ourdiv = $('<div />');
  ourdiv.css({
    'background-image':'url("res/5QDemo/off4/-2030.gif")',
    'background-repeat':'none',
    'background-position':(0-ourtile.x)+'px '+(0-ourtile.y)+'px',
    'width':(ourtile.w)+'px',
    'height':(ourtile.h)+'px',
    'position':'absolute',
    'left':x+'px',
    'top':y+'px',
  });
  ourdiv.appendTo(tmpscreen);
}

function addFrame(frameid) {
  var ourframe = frames[frameid];
  var val = 0;
  if (ourframe.nbimg > 0) {
    var offsetx = ourframe.img[0].ox;
    var offsety = ourframe.img[0].oy;
    var sizex = ourframe.img[0].sx;
    var sizey = ourframe.img[0].sy;
    val = ourframe.img[0].val;
    for(var i = 1; i <= ourframe.nbimg; i++) {
      addTile(ourframe.img[i].idx-1, offsetx+ourframe.img[i].ox, offsety+ourframe.img[i].oy);
      val = val | ourframe.img[i].val;
    }
    return val;
  }
  return val;
}

function getFrameVal(frameid) {
  var ourframe = frames[frameid];
  var val = 0;
  if (ourframe.nbimg > 0) {
    val = ourframe.img[0].val;
    for(var i = 1; i <= ourframe.nbimg; i++) {
      val = val | ourframe.img[i].val;
    }
    return val;
  }
  return val;
}


function nextScreen() {
  $('#screen').html($('#tmpscreen').html()); // Meilleure façon de déplacer les éléments ?
  /*
  // Chrome n'aime pas cette façon non plus
  var newscreen = $('#tmpscreen').clone(true);
  newscreen.attr('id','screen').attr('style',$('#screen').attr('style'));
  $('#screen').replaceWith(newscreen);
  */

  newScreen();
}

function displayFrame(framenum) {
  addFrame(framenum);
  nextScreen();
}

jQuery(document).ready(function() {
  newScreen();
  // Idée : faire un affichage de la liste des frames, avec possibilité de cliquer desssus pour les afficher (sans animation auto) et défilement avec droite/gauche

/*
  jQuery('#debug').html('');
  for(var i = 250;i < 300;i++) { // frames.length
    jQuery('<a href="#" onclick="displayFrame('+i+');return false">display frame '+i+'</a> (val='+getFrameVal(i)+')<br/>').appendTo('#debug');
    
  }
*/

  var framenum = 0;
  var runanim = function() {
    var val = addFrame(framenum);
    if (val != 36) nextScreen();
    jQuery('#debuglive').html('frame '+framenum+'/'+(frames.length)+' ; val:'+val);
    framenum++;
    if (framenum >= frames.length) {
      framenum = 0;
    }
    //setTimeout(runanim,500);
  }

  jQuery('#preload img').imagesLoaded(function (e) {
	waitForAudio(function(){
	  //setTimeout(runanim,500);
	  setInterval(runanim,66); // Pourrait être calculé depuis frames[x].fps1/frames[x].fps2

	  var audiofile = jQuery('#snd1003').get(0);
	  audiofile.currentTime = 0;
	  audiofile.play();
	});
  }, true);

});

</script>
</head>

<body style="background-color:#333">
  <div id="screen" style="background-color:#000;position:relative;width:640px;height:480px;overflow:hidden;margin-left:auto;margin-right:auto;margin-top:30px"></div> <!-- Couleur #EEE pour l'intro -->
  <div id="debuglive" style="background-color:#000;color:#FFF;padding:5px;margin-top:10px;"></div>
  <div id="debug" style="background-color:#000;color:#FFF;padding:5px;margin-top:10px;height:150px;overflow-y:scroll"></div>
  <div id="tmpscreen" style="display:none"></div>
  <div id="preload" style="display:none">
    <img src="res/5QDemo/off4/-2030.gif" />
    <audio id="snd1003">
      <source type="audio/ogg" src="res/5QDemo/snd/3003.ogg" />
      <source type="audio/mpeg" src="res/5QDemo/snd/3003.mp3" />
    </audio>
  </div>
</body>
</html>