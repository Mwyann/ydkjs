<html>
<head>
<title>Test YDKJ</title>
<script src="tiles.js" type="text/javascript"></script>
<script src="jquery-1.11.0.min.js" type="text/javascript"></script>
<script type="text/javascript">

function newScreen() {
  $('#tmpscreen').html('');
}

function addTile(tileid, x, y) {
  var tmpscreen = $('#tmpscreen');
  var ourtile = tiles[tileid];
  if (!ourtile) return false;
  var ourdiv = $('<div />');
  ourdiv.css({
    'background-image':'url("tiles.gif")',
    'background-repeat':'none',
    'background-position':(0-ourtile.x)+'px '+(0-ourtile.y)+'px',
    'width':(ourtile.w)+'px',
    'height':(ourtile.h)+'px',
    'position':'absolute',
    'left':x+'px',
    'top':y+'px',
  });
  ourdiv.appendTo(tmpscreen);
}

function addFrame(frameid) {
  var ourframe = frames[frameid];
  var val = 0;
  if (ourframe.nbimg > 0) {
    var offsetx = ourframe.img[0].ox;
    var offsety = ourframe.img[0].oy;
    var sizex = ourframe.img[0].sx;
    var sizey = ourframe.img[0].sy;
    val = ourframe.img[0].val;
    for(var i = 1; i <= ourframe.nbimg; i++) {
      addTile(ourframe.img[i].idx-1, offsetx+ourframe.img[i].ox, offsety+ourframe.img[i].oy);
      val = val | ourframe.img[i].val;
    }
    return val;
  }
  return val;
}

function getFrameVal(frameid) {
  var ourframe = frames[frameid];
  var val = 0;
  if (ourframe.nbimg > 0) {
    val = ourframe.img[0].val;
    for(var i = 1; i <= ourframe.nbimg; i++) {
      val = val | ourframe.img[i].val;
    }
    return val;
  }
  return val;
}


function nextScreen() {
  $('#screen').html($('#tmpscreen').html()); // Meilleure façon de déplacer les éléments ?
  /*
  // Chrome n'aime pas cette façon non plus
  var newscreen = $('#tmpscreen').clone(true);
  newscreen.attr('id','screen').attr('style',$('#screen').attr('style'));
  $('#screen').replaceWith(newscreen);
  */

  newScreen();
}

function displayFrame(framenum) {
  addFrame(framenum);
  nextScreen();
}

jQuery(document).ready(function() {
  newScreen();
  // Idée : faire un affichage de la liste des frames, avec possibilité de cliquer desssus pour les afficher (sans animation auto) et défilement avec droite/gauche

/*
  jQuery('#debug').html('');
  for(var i = 250;i < 300;i++) { // frames.length
    jQuery('<a href="#" onclick="displayFrame('+i+');return false">display frame '+i+'</a> (val='+getFrameVal(i)+')<br/>').appendTo('#debug');
    
  }
*/

  var framenum = 0;
  var runanim = function() {
    var val = addFrame(framenum);
    nextScreen();
    jQuery('#debuglive').html('frame '+framenum+'/'+(frames.length)+' ; val:'+val);
    framenum++;
    if (framenum >= frames.length) {
      framenum = 0;
    }
    //setTimeout(runanim,500);
  }
  //setTimeout(runanim,500);
  setInterval(runanim,66); // Pourrait être calculé depuis frames[x].fps1/frames[x].fps2
});

</script>
</head>

<body style="background-color:#EEEEEE">
  <div id="screen" style="background-color:#EEEEEE;position:relative;width:640px;height:480px;margin-left:auto;margin-right:auto;margin-top:30px"></div>
  <div id="debuglive" style="background-color:#000;color:#FFF;padding:5px;margin-top:10px;"></div>
  <div id="debug" style="background-color:#000;color:#FFF;padding:5px;margin-top:10px;height:150px;overflow-y:scroll"></div>
  <div id="tmpscreen" style="display:none"></div>
  <div id="preload" style="display:none"></div>
</body>
</html>